function parse_option(e,t){return void 0===e?t:e}function create_object_array(e){const t=Array(e);for(let i=0;i<e;i++)t[i]=create_object();return t}function get_keys(e){return Object.keys(e)}function create_object(){return Object.create(null)}function concat(e){return[].concat.apply([],e)}function sort_by_length_down(e,t){return t.length-e.length}function is_array(e){return e.constructor===Array}function is_string(e){return"string"==typeof e}function is_object(e){return"object"==typeof e}function is_function(e){return"function"==typeof e}function pipeline(e,t,i,r){if(e&&(t&&(e=replace(e,t)),this.matcher&&(e=replace(e,this.matcher)),this.stemmer&&1<e.length&&(e=replace(e,this.stemmer)),r&&1<e.length&&(e=collapse(e)),i||""===i)){const t=e.split(i);return this.filter?filter(t,this.filter):t}return e}const regex_whitespace=/[\p{Z}\p{S}\p{P}\p{C}]+/u;function init_filter(e){const t=create_object();for(let i=0,r=e.length;i<r;i++)t[e[i]]=1;return t}function init_stemmer_or_matcher(e,t){const i=get_keys(e),r=i.length,n=[];let s="",o=0;for(let c,h,l=0;l<r;l++)c=i[l],h=e[c],h?(n[o++]=regex(t?"(?!\\b)"+c+"(\\b|_)":c),n[o++]=h):s+=(s?"|":"")+c;return s&&(n[o++]=regex(t?"(?!\\b)("+s+")(\\b|_)":"("+s+")"),n[o]=""),n}function replace(e,t){for(let i=0,r=t.length;i<r&&(e=e.replace(t[i],t[i+1]));i+=2);return e}function regex(e){return new RegExp(e,"g")}function collapse(e){let t="",i="";for(let r,n=0,s=e.length;n<s;n++)(r=e[n])!==i&&(t+=i=r);return t}function filter(e,t){const i=e.length,r=[];for(let n=0,s=0;n<i;n++){const i=e[n];i&&!t[i]&&(r[s++]=i)}return r}function encode(e){return pipeline.call(this,(""+e).toLowerCase(),!1,regex_whitespace,!1)}const global_lang={},global_charset={};function apply_async(e){register$1(e,"add"),register$1(e,"append"),register$1(e,"search"),register$1(e,"update"),register$1(e,"remove")}function register$1(e,t){e[t+"Async"]=function(){const e=this,i=arguments,r=i[i.length-1];let n;is_function(r)&&(n=r,delete i[i.length-1]);const s=new Promise((function(r){setTimeout((function(){e.async=!0;const n=e[t].apply(e,i);e.async=!1,r(n)}))}));return n?(s.then(n),this):s}}function intersect(e,t,i,r){const n=e.length;let s,o,c=[],h=0;r&&(r=[]);for(let l=n-1;0<=l;l--){const a=e[l],u=a.length,f=create_object();let p=!s;for(let e=0;e<u;e++){const u=a[e],d=u.length;if(d)for(let e,a,g=0;g<d;g++)if(a=u[g],s){if(s[a]){if(!l)if(i)i--;else if(c[h++]=a,h===t)return c;(l||r)&&(f[a]=1),p=!0}if(r&&(e=(o[a]||0)+1,o[a]=e,e<n)){const t=r[e-2]||(r[e-2]=[]);t[t.length]=a}}else f[a]=1}if(r)s||(o=f);else if(!p)return[];s=f}if(r)for(let e,n,o=r.length-1;0<=o;o--){e=r[o],n=e.length;for(let r,o=0;o<n;o++)if(r=e[o],!s[r]){if(i)i--;else if(c[h++]=r,h===t)return c;s[r]=1}}return c}function intersect_union(e,t){const i=create_object(),r=create_object(),n=[];for(let t=0;t<e.length;t++)i[e[t]]=1;for(let e,s=0;s<t.length;s++){e=t[s];for(let t,s=0;s<e.length;s++)t=e[s],i[t]&&!r[t]&&(r[t]=1,n[n.length]=t)}return n}function CacheClass(e){this.limit=!0!==e&&e,this.cache=create_object(),this.queue=[]}function searchCache(e,t,i){is_object(e)&&(e=e.query);let r=this.cache.get(e);return r||(r=this.search(e,t,i),this.cache.set(e,r)),r}CacheClass.prototype.set=function(e,t){if(!this.cache[e]){let t=this.queue.length;t===this.limit?delete this.cache[this.queue[t-1]]:t++;for(let e=t-1;0<e;e--)this.queue[e]=this.queue[e-1];this.queue[0]=e}this.cache[e]=t},CacheClass.prototype.get=function(e){const t=this.cache[e];if(this.limit&&t){const t=this.queue.indexOf(e);if(t){const e=this.queue[t-1];this.queue[t-1]=this.queue[t],this.queue[t]=e}}return t},CacheClass.prototype.del=function(e){for(let t,i,r=0;r<this.queue.length;r++)i=this.queue[r],t=this.cache[i],t.includes(e)&&(this.queue.splice(r--,1),delete this.cache[i])};const preset={memory:{charset:"latin:extra",resolution:3,minlength:4,fastupdate:!1},performance:{resolution:3,minlength:3,optimize:!1,context:{depth:2,resolution:1}},match:{charset:"latin:extra",tokenize:"reverse"},score:{charset:"latin:advanced",resolution:20,minlength:3,context:{depth:3,resolution:9}},default:{}};function apply_preset(e){if(is_string(e))e=preset[e];else{const t=e.preset;t&&(e=Object.assign({},t[t],e))}return e}function async(e,t,i,r,n,s,o){setTimeout((function(){const c=e(i?i+"."+r:r,JSON.stringify(o));c&&c.then?c.then((function(){t.export(e,t,i,n,s+1)})):t.export(e,t,i,n,s+1)}))}function exportIndex(e,t,i,r,n){let s,o;switch(n||(n=0)){case 0:if(s="reg",this.fastupdate)for(let e in o=create_object(),this.register)o[e]=1;else o=this.register;break;case 1:s="cfg",o={doc:0,opt:this.optimize?1:0};break;case 2:s="map",o=this.map;break;case 3:s="ctx",o=this.ctx;break;default:return}return async(e,t||this,i,s,r,n,o),!0}function importIndex(e,t){t&&(is_string(t)&&(t=JSON.parse(t)),"cfg"===e?this.optimize=!!t.opt:"reg"===e?(this.fastupdate=!1,this.register=t):"map"===e?this.map=t:"ctx"===e&&(this.ctx=t))}function exportDocument(e,t,i,r,n){if(n||(n=0),r||(r=0),r<this.field.length){const i=this.field[r],s=this.index[i];t=this,setTimeout((function(){s.export(e,t,n?i:"",r,n++)||(r++,n=1,t.export(e,t,i,r,n))}))}else{let t,s;switch(n){case 1:t="tag",s=this.tagindex;break;case 2:t="store",s=this.store;break;default:return}async(e,this,i,t,r,n,s)}}function importDocument(e,t){if(t)switch(is_string(t)&&(t=JSON.parse(t)),e){case"tag":this.tagindex=t;break;case"reg":this.fastupdate=!1,this.register=t;for(let e,i=0;i<this.field.length;i++)e=this.index[this.field[i]],e.register=t,e.fastupdate=!1;break;case"store":this.store=t;break;default:const i=(e=e.split("."))[0];e=e[1],i&&e&&this.index[i].import(e,t)}}function Index(e,t){if(!(this instanceof Index))return new Index(e);let i,r,n;e?(i=(e=apply_preset(e)).charset,r=e.lang,is_string(i)&&(-1===i.indexOf(":")&&(i+=":default"),i=global_charset[i]),is_string(r)&&(r=global_lang[r])):e={};let s,o,c=e.context||{};this.encode=e.encode||i&&i.encode||encode,this.register=t||create_object(),this.resolution=s=e.resolution||9,this.tokenize=n=i&&i.tokenize||e.tokenize||"strict",this.depth="strict"===n&&c.depth,this.bidirectional=parse_option(c.bidirectional,!0),this.optimize=o=parse_option(e.optimize,!0),this.fastupdate=parse_option(e.fastupdate,!0),this.minlength=e.minlength||1,this.boost=e.boost,this.map=o?create_object_array(s):create_object(),this.resolution_ctx=s=c.resolution||1,this.ctx=o?create_object_array(s):create_object(),this.rtl=i&&i.rtl||e.rtl,this.matcher=(n=e.matcher||r&&r.matcher)&&init_stemmer_or_matcher(n,!1),this.stemmer=(n=e.stemmer||r&&r.stemmer)&&init_stemmer_or_matcher(n,!0),this.filter=(n=e.filter||r&&r.filter)&&init_filter(n),this.cache=(n=e.cache)&&new CacheClass(n)}function get_score(e,t,i,r,n){return i&&1<e?t+(r||0)<=e?i+(n||0):0|(e-1)/(t+(r||0))*(i+(n||0))+1:0}function single_result(e,t,i){return e=1===e.length?e[0]:concat(e),i||e.length>t?e.slice(i,i+t):e}function get_array(e,t,i,r){if(i){const n=r&&t>i;e=(e=e[n?t:i])&&e[n?i:t]}else e=e[t];return e}function remove_index(e,t,i,r,n){let s=0;if(is_array(e))if(n){const i=e.indexOf(t);-1===i?s++:1<e.length&&(e.splice(i,1),s++)}else{n=Math.min(e.length,i);for(let o,c=0;c<n;c++)o=e[c],o&&(s=remove_index(o,t,i,r,n),!r&&!s&&delete e[c])}else for(let o in e)s=remove_index(e[o],t,i,r,n),s||delete e[o];return s}function handler(e){e=e.data;const t=self._index,i=e.args,r=e.task;if("init"===r){const t=e.options||{},i=e.factory,r=t.encode;t.cache=!1,r&&0===r.indexOf("function")&&(t.encode=Function("return "+r)()),i?(Function("return "+i)()(self),self._index=new self.FlexSearch.Index(t),delete self.FlexSearch):self._index=new Index(t)}else{const n=e.id,s=t[r].apply(t,i);postMessage("search"===r?{id:n,msg:s}:{id:n})}}Index.prototype.append=function(e,t){return this.add(e,t,!0)},Index.prototype.add=function(e,t,i,r){if(t&&(e||0===e)){if(!r&&!i&&this.register[e])return this.update(e,t);const n=(t=this.encode(""+t)).length;if(n){const r=create_object(),s=create_object(),o=this.depth,c=this.resolution;for(let h=0;h<n;h++){let l=t[this.rtl?n-1-h:h],a=l.length;if(l&&a>=this.minlength&&(o||!s[l])){let u=get_score(c,n,h),f="";switch(this.tokenize){case"full":if(2<a){for(let t=0;t<a;t++)for(let r=a;r>t;r--)if(r-t>=this.minlength){const o=get_score(c,n,h,a,t);f=l.substring(t,r),this.push_index(s,f,o,e,i)}break}case"reverse":if(1<a){for(let t=a-1;0<t;t--)if(f=l[t]+f,f.length>=this.minlength){const r=get_score(c,n,h,a,t);this.push_index(s,f,r,e,i)}f=""}case"forward":if(1<a){for(let t=0;t<a;t++)f+=l[t],f.length>=this.minlength&&this.push_index(s,f,u,e,i);break}default:if(this.boost&&(u=Math.min(0|u/this.boost(t,l,h),c-1)),this.push_index(s,l,u,e,i),o&&1<n&&h<n-1){const s=create_object(),c=this.resolution_ctx,a=l,u=Math.min(o+1,n-h);s[a]=1;for(let o=1;o<u;o++)if(l=t[this.rtl?n-1-h-o:h+o],l&&l.length>=this.minlength&&!s[l]){s[l]=1;const t=get_score(c+(n/2>c?0:1),n,h,u-1,o-1),f=this.bidirectional&&l>a;this.push_index(r,f?a:l,t,e,i,f?l:a)}}}}}this.fastupdate||(this.register[e]=1)}}return this},Index.prototype.push_index=function(e,t,i,r,n,s){let o=s?this.ctx:this.map;if((!e[t]||s&&!e[t][s])&&(this.optimize&&(o=o[i]),s?((e=e[t]||(e[t]=create_object()))[s]=1,o=o[s]||(o[s]=create_object())):e[t]=1,o=o[t]||(o[t]=[]),this.optimize||(o=o[i]||(o[i]=[])),(!n||!o.includes(r))&&(o[o.length]=r,this.fastupdate))){const e=this.register[r]||(this.register[r]=[]);e[e.length]=o}},Index.prototype.search=function(e,t,i){i||(!t&&is_object(e)?e=(i=e).query:is_object(t)&&(i=t));let r,n,s,o=[],c=0;if(i&&(e=i.query||e,t=i.limit,c=i.offset||0,n=i.context,s=i.suggest),e&&(r=(e=this.encode(""+e)).length,1<r)){const t=create_object(),i=[];for(let n,c=0,h=0;c<r;c++)if(n=e[c],n&&n.length>=this.minlength&&!t[n]){if(!this.optimize&&!s&&!this.map[n])return o;i[h++]=n,t[n]=1}r=(e=i).length}if(!r)return o;t||(t=100);let h,l=this.depth&&1<r&&!1!==n,a=0;l?(h=e[0],a=1):1<r&&e.sort(sort_by_length_down);for(let i,n;a<r;a++){if(n=e[a],l?(i=this.add_result(o,s,t,c,2===r,n,h),(!s||!1!==i||!o.length)&&(h=n)):i=this.add_result(o,s,t,c,1===r,n),i)return i;if(s&&a==r-1){let e=o.length;if(!e){if(l){l=0,a=-1;continue}return o}if(1===e)return single_result(o[0],t,c)}}return intersect(o,t,c,s)},Index.prototype.add_result=function(e,t,i,r,n,s,o){let c=[],h=o?this.ctx:this.map;if(this.optimize||(h=get_array(h,s,o,this.bidirectional)),h){let t=0;const l=Math.min(h.length,o?this.resolution_ctx:this.resolution);for(let e,a,u=0,f=0;u<l&&(e=h[u],!(e&&(this.optimize&&(e=get_array(e,s,o,this.bidirectional)),r&&e&&n&&(a=e.length,a<=r?(r-=a,e=null):(e=e.slice(r),r=0)),e&&(c[t++]=e,n&&(f+=e.length,f>=i)))));u++);if(t)return n?single_result(c,i,0):void(e[e.length]=c)}return!t&&c},Index.prototype.contain=function(e){return!!this.register[e]},Index.prototype.update=function(e,t){return this.remove(e).add(e,t)},Index.prototype.remove=function(e,t){const i=this.register[e];if(i){if(this.fastupdate)for(let t,r=0;r<i.length;r++)t=i[r],t.splice(t.indexOf(e),1);else remove_index(this.map,e,this.resolution,this.optimize),this.depth&&remove_index(this.ctx,e,this.resolution_ctx,this.optimize);t||delete this.register[e],this.cache&&this.cache.del(e)}return this},Index.prototype.searchCache=searchCache,Index.prototype.export=exportIndex,Index.prototype.import=importIndex,apply_async(Index.prototype);let pid=0;function WorkerIndex(e){if(!(this instanceof WorkerIndex))return new WorkerIndex(e);let t;e?is_function(t=e.encode)&&(e.encode=t.toString()):e={};let i=(self||window)._factory;i&&(i=i.toString());const r="undefined"==typeof window&&self.exports,n=this;this.worker=create(i,r,e.worker),this.resolver=create_object(),this.worker&&(r?this.worker.on("message",(function(e){n.resolver[e.id](e.msg),delete n.resolver[e.id]})):this.worker.onmessage=function(e){e=e.data,n.resolver[e.id](e.msg),delete n.resolver[e.id]},this.worker.postMessage({task:"init",factory:i,options:e}))}function register(e){WorkerIndex.prototype[e]=WorkerIndex.prototype[e+"Async"]=function(){const t=this,i=[].slice.call(arguments),r=i[i.length-1];let n;is_function(r)&&(n=r,i.splice(i.length-1,1));const s=new Promise((function(r){setTimeout((function(){t.resolver[++pid]=r,t.worker.postMessage({task:e,id:pid,args:i})}))}));return n?(s.then(n),this):s}}function create(factory,is_node_js,worker_path){let worker;try{worker=is_node_js?eval('new (require("worker_threads")["Worker"])("../dist/node/node.js")'):factory?new Worker(URL.createObjectURL(new Blob(["onmessage="+handler.toString()],{type:"text/javascript"}))):new Worker(is_string(worker_path)?worker_path:"worker/worker.js",{type:"module"})}catch(e){}return worker}function Document(e){if(!(this instanceof Document))return new Document(e);const t=e.document||e.doc||e;let i;this.tree=[],this.field=[],this.marker=[],this.register=create_object(),this.key=(i=t.key||t.id)&&parse_tree(i,this.marker)||"id",this.fastupdate=parse_option(e.fastupdate,!0),this.storetree=(i=t.store)&&!0!==i&&[],this.store=i&&create_object(),this.tag=(i=t.tag)&&parse_tree(i,this.marker),this.tagindex=i&&create_object(),this.cache=(i=e.cache)&&new CacheClass(i),e.cache=!1,this.worker=e.worker,this.async=!1,this.index=parse_descriptor.call(this,e,t)}function parse_descriptor(e,t){const i=create_object();let r=t.index||t.field||t;is_string(r)&&(r=[r]);for(let t,n,s=0;s<r.length;s++)t=r[s],is_string(t)||(n=t,t=t.field),n=is_object(n)?Object.assign({},e,n):e,this.worker&&(i[t]=new WorkerIndex(n),!i[t].worker&&(this.worker=!1)),this.worker||(i[t]=new Index(n,this.register)),this.tree[s]=parse_tree(t,this.marker),this.field[s]=t;if(this.storetree){let e=t.store;is_string(e)&&(e=[e]);for(let t=0;t<e.length;t++)this.storetree[t]=parse_tree(e[t],this.marker)}return i}function parse_tree(e,t){const i=e.split(":");let r=0;for(let n=0;n<i.length;n++)0<=(e=i[n]).indexOf("[]")&&((e=e.substring(0,e.length-2))&&(t[r]=!0)),e&&(i[r++]=e);return r<i.length&&(i.length=r),1<r?i:i[0]}function parse_simple(e,t){if(is_string(t))e=e[t];else for(let i=0;e&&i<t.length;i++)e=e[t[i]];return e}function store_value(e,t,i,r,n){if(e=e[n],r===i.length-1)t[n]=e;else if(e)if(is_array(e)){t=t[n]=Array(e.length);for(let n=0;n<e.length;n++)store_value(e,t,i,r,n)}else t=t[n]||(t[n]=create_object()),n=i[++r],store_value(e,t,i,r,n)}function add_index(e,t,i,r,n,s,o,c){if(e=e[o])if(r===t.length-1){if(is_array(e)){if(i[r]){for(let t=0;t<e.length;t++)n.add(s,e[t],!0,!0);return}e=e.join(" ")}n.add(s,e,c,!0)}else if(is_array(e))for(let o=0;o<e.length;o++)add_index(e,t,i,r,n,s,o,c);else o=t[++r],add_index(e,t,i,r,n,s,o,c)}function get_tag(e,t,i,r){let n=this.tagindex[e],s=n&&n.length-i;if(s&&0<s)return(s>t||i)&&(n=n.slice(i,i+t)),r&&(n=apply_enrich.call(this,n)),{tag:e,result:n}}function apply_enrich(e){const t=Array(e.length);for(let i,r=0;r<e.length;r++)i=e[r],t[r]={id:i,doc:this.store[i]};return t}register("add"),register("append"),register("search"),register("update"),register("remove"),Document.prototype.add=function(e,t,i){if(is_object(e)&&(e=parse_simple(t=e,this.key)),t&&(e||0===e)){if(!i&&this.register[e])return this.update(e,t);for(let r,n,s=0;s<this.field.length;s++)n=this.field[s],r=this.tree[s],is_string(r)&&(r=[r]),add_index(t,r,this.marker,0,this.index[n],e,r[0],i);if(this.tag){let r=parse_simple(t,this.tag),n=create_object();is_string(r)&&(r=[r]);for(let t,s,o=0;o<r.length;o++)if(t=r[o],!n[t]&&(n[t]=1,s=this.tagindex[t]||(this.tagindex[t]=[]),(!i||!s.includes(e))&&(s[s.length]=e,this.fastupdate))){const t=this.register[e]||(this.register[e]=[]);t[t.length]=s}}if(this.store&&(!i||!this.store[e])){let i;if(this.storetree){i=create_object();for(let e,r=0;r<this.storetree.length;r++)e=this.storetree[r],is_string(e)?i[e]=t[e]:store_value(t,i,e,0,e[0])}this.store[e]=i||t}}return this},Document.prototype.append=function(e,t){return this.add(e,t,!0)},Document.prototype.update=function(e,t){return this.remove(e).add(e,t)},Document.prototype.remove=function(e){if(is_object(e)&&(e=parse_simple(e,this.key)),this.register[e]){for(let t=0;t<this.field.length&&(this.index[this.field[t]].remove(e,!this.worker),!this.fastupdate);t++);if(this.tag&&!this.fastupdate)for(let t in this.tagindex){const i=this.tagindex[t],r=i.indexOf(e);-1!==r&&(1<i.length?i.splice(r,1):delete this.tagindex[t])}this.store&&delete this.store[e],delete this.register[e]}return this},Document.prototype.search=function(e,t,i,r){i||(!t&&is_object(e)?(i=e,e=""):is_object(t)&&(i=t,t=0));let n,s,o,c,h,l,a=[],u=[],f=0;if(i)if(is_array(i))o=i,i=null;else{if(e=i.query||e,n=i.pluck,o=n||i.index||i.field,c=i.tag,s=this.store&&i.enrich,h="and"===i.bool,t=i.limit||t||100,l=i.offset||0,c&&(is_string(c)&&(c=[c]),!e)){for(let e,i=0;i<c.length;i++)e=get_tag.call(this,c[i],t,l,s),e&&(a[a.length]=e,f++);return f?a:[]}is_string(o)&&(o=[o])}o||(o=this.field),h=h&&(1<o.length||c&&1<c.length);const p=!r&&(this.worker||this.async)&&[];for(let n,s,d,g=0;g<o.length;g++){let _;if(s=o[g],is_string(s)||(_=s,s=_.field,e=_.query||e,t=_.limit||t),p)p[g]=this.index[s].searchAsync(e,t,_||i);else{if(n=r?r[g]:this.index[s].search(e,t,_||i),d=n&&n.length,c&&d){const e=[];let i=0;h&&(e[0]=[n]);for(let t,r,n=0;n<c.length;n++)t=c[n],r=this.tagindex[t],d=r&&r.length,d&&(i++,e[e.length]=h?[r]:r);i&&(n=h?intersect(e,t||100,l||0):intersect_union(n,e),d=n.length)}if(d)u[f]=s,a[f++]=n;else if(h)return[]}}if(p){const r=this;return new Promise((function(n){Promise.all(p).then((function(s){n(r.search(e,t,i,s))}))}))}if(!f)return[];if(n&&(!s||!this.store))return a[0];for(let e,t=0;t<u.length;t++){if(e=a[t],e.length&&s&&(e=apply_enrich.call(this,e)),n)return e;a[t]={field:u[t],result:e}}return a},Document.prototype.contain=function(e){return!!this.register[e]},Document.prototype.get=function(e){return this.store[e]},Document.prototype.set=function(e,t){return this.store[e]=t,this},Document.prototype.searchCache=searchCache,Document.prototype.export=exportDocument,Document.prototype.import=importDocument,apply_async(Document.prototype);export{Document as D};
